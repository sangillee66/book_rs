{
  "hash": "f99ffbf48483da2672001497abf8a6bc",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"변화 탐지\"\nauthor: Sang-Il Lee\ndate-modified: last-modified\nnumber-sections: true\nformat: \n  html: \n    toc: true\ncode-link: true\ncode-copy: true\nlightbox: true\nexecute: \n  warning: false\n  error: false\n  freeze: auto\neditor: visual\neditor_options: \n  chunk_output_type: console\n---\n\n\n## 개요\n\n필수적인 패키지를 불러온다.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(sf)\nlibrary(terra)\nlibrary(tmap)\nlibrary(RStoolbox)\nlibrary(RColorBrewer)\n```\n:::\n\n\n서울의 행정구역 바운더리 파일을 불러온다.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nseoul <- st_read(\"D:/My R/Korean Administrative Areas/행정구역 셰이프 파일/2 Original Cleaning/2023_2Q/SEOUL_SIDO_2023_2Q.shp\")\nseoul_gu <- st_read(\"D:/My R/Korean Administrative Areas/행정구역 셰이프 파일/2 Original Cleaning/2023_2Q/SEOUL_GU_2023_2Q.shp\")\nseoul_dong <- st_read(\"D:/My R/Korean Administrative Areas/행정구역 셰이프 파일/2 Original Cleaning/2023_2Q/SEOUL_EMD_2023_2Q.shp\")\n```\n:::\n\n\n2024년에 촬영된 Landsat 영상과 1983년에 촬영된 Landsat 영상을 비교하고자 한다. 2024년 데이터를 불러와 마스킹한다.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlevel2_landsat_seoul_st <- rast(\"D:/My R/World Data Manupulation/USGS EarthExplorer/level2_landsat_seoul_stack.tif\")\nseoul_2024 <- level2_landsat_seoul_st |> \n  mask(seoul)\n```\n:::\n\n\n1994년 데이터를 불러와 마스킹한다.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlevel2_landsat_seoul_st_1994 <- rast(\"D:/My R/World Data Manupulation/USGS EarthExplorer/level2_landsat_seoul_stack_1994.tif\")\nseoul_1994 <- level2_landsat_seoul_st_1994 |> \n  mask(seoul)\n```\n:::\n\n\n1994년 데이터를 2024년에 맞게 조정한다. 미묘하게 다른 extent와 resolution을 일치시킨다.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nseoul_1994 <- resample(seoul_1994, seoul_2024, method = \"bilinear\")\n```\n:::\n\n\n## 영상 대수를 활용한 변화 유무 탐지\n\nNDVI를 비교하고자 한다. 2024년의 NDVI를 계산한다.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nNDVI_2024 <- (seoul_2024$`B5(NIR)` - seoul_2024$`B4(Red)`) / (seoul_2024$`B5(NIR)` + seoul_2024$`B4(Red)`)\nnames(NDVI_2024) <- \"NDVI\"\nggR(NDVI_2024)\n```\n\n::: {.cell-output-display}\n![](4_4_change_detection_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n:::\n\n\n1994년의 NDVI를 계산한다.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nNDVI_1994 <- (seoul_1994$`B4(Nir)` - seoul_1994$`B3(Red)`) / ((seoul_1994$`B4(Nir)` + seoul_1994$`B3(Red)`))\nnames(NDVI_1994) <- \"NDVI\"\nqtm(NDVI_1994)\n```\n\n::: {.cell-output-display}\n![](4_4_change_detection_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n\n\n둘 사이의 영상 일치도를 높이기 위해 '영상대영상 대조 매칭(image to image contrast matching)'을 실시한다. [`RSToolbox`](https://bleutner.github.io/RStoolbox/) 패키지의 `histMatch()` 함수를 활용한다.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nNDVI_1994_new <- histMatch(NDVI_1994, NDVI_2024)\nqtm(NDVI_1994_new)\n```\n\n::: {.cell-output-display}\n![](4_4_change_detection_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n:::\n\n\n2024년의 NDVI에 대한 지도를 제작한다.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmy_palette <- colorRampPalette(brewer.pal(11, \"RdYlGn\"))(100)\nmy_map <- tm_shape(NDVI_2024, raster.downsample = FALSE) + \n  tm_raster(style = \"cont\", palette = my_palette, title = \"NDVI\", midpoint = 0) +\n  tm_shape(seoul) + tm_borders(lwd = 2, col = \"gray20\") +\n  tm_legend(legend.position = c(0.85, 0.06)) +\n  tm_layout(frame = TRUE, title = \"NDVI (2024)\", title.size = 2, \n            title.position = c(\"left\", \"top\"), bg.color = \"white\", \n            inner.margins = c(0.05, 0.05, 0.05, 0.05)) +\n  tm_scale_bar(color.dark = \"gray60\", position = c(0.01, 0.01), size = 0.6, breaks = seq(0, 20, 5)) + \n  tm_credits(\"SANG-IL LEE, Geography Education at SNU, 2025\", size = 0.7)\nmy_map\n```\n\n::: {.cell-output-display}\n![](4_4_change_detection_files/figure-html/unnamed-chunk-9-1.png){width=4500}\n:::\n:::\n\n::: {.cell}\n\n:::\n\n\n1994년의 NDVI에 대한 지도를 제작한다.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmy_palette <- colorRampPalette(brewer.pal(11, \"RdYlGn\"))(100)\nmy_map <- tm_shape(NDVI_1994_new, raster.downsample = FALSE) + \n  tm_raster(style = \"cont\", palette = my_palette, title = \"NDVI\", midpoint = 0) +\n  tm_shape(seoul) + tm_borders(lwd = 2, col = \"gray20\") +\n  tm_legend(legend.position = c(0.85, 0.06)) +\n  tm_layout(frame = TRUE, title = \"NDVI (1994)\", title.size = 2, \n            title.position = c(\"left\", \"top\"), bg.color = \"white\", \n            inner.margins = c(0.05, 0.05, 0.05, 0.05)) +\n  tm_scale_bar(color.dark = \"gray60\", position = c(0.01, 0.01), size = 0.6, breaks = seq(0, 20, 5)) + \n  tm_credits(\"SANG-IL LEE, Geography Education at SNU, 2025\", size = 0.7)\nmy_map\n```\n\n::: {.cell-output-display}\n![](4_4_change_detection_files/figure-html/unnamed-chunk-11-1.png){width=4500}\n:::\n:::\n\n::: {.cell}\n\n:::\n\n\n차분을 이용해 변화를 탐지한다.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nNDVI_diff <- NDVI_2024 - NDVI_1994_new\nqtm(NDVI_diff)\n```\n\n::: {.cell-output-display}\n![](4_4_change_detection_files/figure-html/unnamed-chunk-13-1.png){width=672}\n:::\n:::\n\n\n표준편차를 계산한다.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nglobal(NDVI_diff, fun = sd, na.rm = TRUE) |> round(digits = 1)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n      sd\nNDVI 0.1\n```\n\n\n:::\n:::\n\n\n0.1을 임계값으로 하여 범주를 구분한다.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nNDVI_diff_cat <- classify(\n  NDVI_diff, matrix(c(-Inf, -0.1, 1, -1, 0.1, 2, 0.1, Inf, 3), ncol = 3, byrow = TRUE))\nNDVI_diff_cat <- as.factor(NDVI_diff_cat)\nqtm(NDVI_diff_cat)\n```\n\n::: {.cell-output-display}\n![](4_4_change_detection_files/figure-html/unnamed-chunk-15-1.png){width=672}\n:::\n:::\n\n\n지도를 제작한다.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmy_map <- tm_shape(NDVI_diff_cat, raster.downsample = FALSE) + \n  tm_raster(style = \"cat\", \n            palette = c(\"red\", \"gray80\", \"darkgreen\"), title = \"Categories\", labels = c(\"Loss\", \"No Change\", \"Gain\")) +\n  tm_shape(seoul) + tm_borders(col = \"black\", lwd = 2) +\n  tm_legend(legend.position = c(0.87, 0.05), \n            legend.bg.color = \"white\", legend.bg.alpha = 0.6, \n            legend.title.size = 1.5, legend.text.size = 1.2) +\n  tm_layout(inner.margins = c(0.05, 0.04, 0.06, 0.04), \n            title = \"Change Detection: Vegetation\", title.size = 2,\n            title.position = c(0.02, 0.97)) + \n  tm_scale_bar(breaks = seq(0, 20, 5), text.size = 0.6, \n               color.dark = \"gray60\", position = c(0.03, 0.01)) +\n  tm_credits(text = \"SANG-IL LEE, Geography Education at SNU, 2025\",\n             size = 0.8, position = c(0.76, 0.01))\nmy_map\n```\n\n::: {.cell-output-display}\n![](4_4_change_detection_files/figure-html/unnamed-chunk-16-1.png){width=4500}\n:::\n:::\n\n::: {.cell}\n\n:::\n\n\n## 다중 시기 조합 영상 변화 탐지\n\nPCA 조합 영상을 통해 변화 탐지를 한다. 두 시기의 Landsat으로 부터 Blue, Green, Red, NIR 밴드를 추출하고, 그것에 PCA을 적용하는 기법을 사용한다.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nchange_detect_PCA <- c(\n  seoul_2024[[c(\"B2(Blue)\", \"B3(Green)\", \"B4(Red)\", \"B5(NIR)\")]], \n  seoul_1994[[c(\"B1(Blue)\", \"B2(Green)\", \"B3(Red)\", \"B4(Nir)\")]]\n)\n```\n:::\n\n\nPCA를 적용한다.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nPCA_res <- rasterPCA(\n  change_detect_PCA,\n  spca = TRUE\n)\nPCA_map <- PCA_res$map |> stretch(minv = 0, maxv = 255, minq = 0.05, maxq = 0.95)\n```\n:::\n\n\nPCA 결과를 살펴본다.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsnu_PCA_res_recal <- function(PCA_RES){\n  res <- PCA_RES\n  n <- length(res$model$center)\n  recal <- bind_rows(as_tibble(res$model$loadings[1:n,]), as_tibble(t(res$model$sdev)))\n  recal <- recal |> mutate(\n    band_id = c(str_c(\"B\", 1:(n() - 1)), \"Eigen\"), .before = 1\n    ) \n  recal[1:n, 2:(n+1)] <- recal[1:n, 2:(n+1)] * recal[(n+1), 2:(n+1)][rep(1, n), ]\n  recal[(n + 1), 2:(n+1)] <- recal[(n + 1), 2:(n+1)]^2\n  recal[(n + 2), 2:(n+1)] <- recal[(n + 1), 2:(n+1)]*100/n\n  recal[(n + 2), 1] <- \"Pct\"\n  recal[(n + 3), 2:(n+1)] <- t(cumsum(as.numeric(recal[(n + 2), 2:(n+1)])))\n  recal[(n + 3), 1] <- \"Cum_Pct\"\n  recal\n  }\n\nsnu_PCA_res_recal(PCA_res)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 11 × 9\n   band_id Comp.1   Comp.2   Comp.3   Comp.4   Comp.5   Comp.6   Comp.7   Comp.8\n   <chr>    <dbl>    <dbl>    <dbl>    <dbl>    <dbl>    <dbl>    <dbl>    <dbl>\n 1 B1       0.894  0.147    0.392    0.0246   0.146    0.0531   1.22e-2  1.73e-2\n 2 B2       0.902  0.207    0.368    0.00339 -0.0414  -0.0146  -5.60e-2 -6.04e-2\n 3 B3       0.908  0.171    0.358    0.0342  -0.108   -0.0394   4.39e-2  4.34e-2\n 4 B4      -0.323  0.895    0.00334 -0.309    0.00160  0.00138  4.76e-4  5.97e-3\n 5 B5       0.917 -0.0596  -0.363   -0.0601   0.0677  -0.122    2.02e-2 -1.03e-2\n 6 B6       0.912  0.0241  -0.397   -0.0118  -0.0204   0.0333  -7.99e-2  4.24e-2\n 7 B7       0.915  0.00354 -0.383   -0.0447  -0.0400   0.0901   6.03e-2 -3.12e-2\n 8 B8      -0.170  0.914   -0.228    0.288    0.00962 -0.00841  5.19e-3 -4.76e-3\n 9 Eigen    5.08   1.73     0.905    0.186    0.0415   0.0289   1.57e-2  8.76e-3\n10 Pct     63.5   21.7     11.3      2.32     0.519    0.361    1.96e-1  1.09e-1\n11 Cum_Pct 63.5   85.2     96.5     98.8     99.3     99.7      9.99e+1  1   e+2\n```\n\n\n:::\n:::\n\n\nPCA가 생성한 이미지를 검토한다. PC4가 식생의 변화를 가장 잘 보여주는 이미지로 판단된다.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nqtm(PCA_map[[\"PC4\"]])\n```\n\n::: {.cell-output-display}\n![](4_4_change_detection_files/figure-html/unnamed-chunk-21-1.png){width=672}\n:::\n:::\n\n\n표준점수로 전환한다.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nPC4_norm <- normImage(PCA_map[[\"PC4\"]])\n```\n:::\n\n\n-1과 1을 임계값으로 하여 범주를 구분한다.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nPC4_diff_cat <- classify(\n  PC4_norm, matrix(c(-Inf, -1.5, 1, -1.5, 1.5, 2, 1.5, Inf, 3), ncol = 3, byrow = TRUE))\nPC4_diff_cat <- as.factor(PC4_diff_cat)\n# qtm(PC4_diff_cat)\n```\n:::\n\n\n지도를 제작한다.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmy_map <- tm_shape(PC4_diff_cat, raster.downsample = FALSE) + \n  tm_raster(style = \"cat\", \n            palette = c(\"red\", \"gray80\", \"darkgreen\"), title = \"Categories\", labels = c(\"Negative\", \"No Change\", \"Positive\")) +\n  tm_shape(seoul) + tm_borders(col = \"black\", lwd = 2) +\n  tm_legend(legend.position = c(0.87, 0.05), \n            legend.bg.color = \"white\", legend.bg.alpha = 0.6, \n            legend.title.size = 1.5, legend.text.size = 1.2) +\n  tm_layout(inner.margins = c(0.05, 0.04, 0.06, 0.04), \n            title = \"Change Detection: PCA\", title.size = 2,\n            title.position = c(0.02, 0.97)) + \n  tm_scale_bar(breaks = seq(0, 20, 5), text.size = 0.6, \n               color.dark = \"gray60\", position = c(0.03, 0.01)) +\n  tm_credits(text = \"SANG-IL LEE, Geography Education at SNU, 2025\",\n             size = 0.8, position = c(0.76, 0.01))\nmy_map\n```\n\n::: {.cell-output-display}\n![](4_4_change_detection_files/figure-html/unnamed-chunk-24-1.png){width=4500}\n:::\n:::\n\n::: {.cell}\n\n:::\n",
    "supporting": [
      "4_4_change_detection_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}