{
  "hash": "594250a5931df389468ddc973c3310e2",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"영상 변환\"\nauthor: Sang-Il Lee\ndate-modified: last-modified\nnumber-sections: true\nformat: \n  html: \n    toc: true\ncode-link: true\ncode-copy: true\nlightbox: true\nexecute: \n  warning: false\n  error: false\n  freeze: auto\neditor: visual\neditor_options: \n  chunk_output_type: console\n---\n\n\n## 개요\n\n영상 변환(image transformation)에는 다음과 같은 기법이 포함된다.\n\n-   영상 재계산(image recalculation)\n\n-   영상 대수(image algebra)\n\n-   분광 지수(spectral index)\n\n-   질감 변환(texture transformation)\n\n-   경관생태지수(landscape ecology metrics)\n\n-   PCA 변환(principal component analysis transformation)\n\n필수적인 패키지를 설치한다.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(sf)\nlibrary(tmap)\nlibrary(terra)\nlibrary(RStoolbox)\nlibrary(RColorBrewer)\n```\n:::\n\n\n서울의 행정구역 바운더리 파일을 불러온다.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nseoul <- st_read(\"D:/My R/Korean Administrative Areas/행정구역 셰이프 파일/2 Original Cleaning/2023_2Q/SEOUL_SIDO_2023_2Q.shp\")\nseoul_gu <- st_read(\"D:/My R/Korean Administrative Areas/행정구역 셰이프 파일/2 Original Cleaning/2023_2Q/SEOUL_GU_2023_2Q.shp\")\nseoul_dong <- st_read(\"D:/My R/Korean Administrative Areas/행정구역 셰이프 파일/2 Original Cleaning/2023_2Q/SEOUL_EMD_2023_2Q.shp\")\n```\n:::\n\n\nLevel-2 데이터를 불러와 마스킹한다.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlevel2_landsat_seoul_st <- rast(\"D:/My R/World Data Manupulation/USGS EarthExplorer/level2_landsat_seoul_stack.tif\")\nlevel2_landsat_seoul_st_mask <- level2_landsat_seoul_st |> \n  mask(seoul)\n```\n:::\n\n\n대비 확장을 시행한다.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlevel2_landsat_seoul_st_mask_str <- level2_landsat_seoul_st_mask |> \n  stretch(minv = 0, maxv = 255, minq = 0.05, maxq = 0.95)\n```\n:::\n\n\n## 영상 재계산\n\n## 영상 대수\n\n적외선-컬러 영상을 제작한다.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmy_map <- tm_shape(level2_landsat_seoul_st_mask_str, \n                   raster.downsample = FALSE) + \n  tm_rgb(r = 5, g = 4, b = 3, legend.show = FALSE) +\n  tm_shape(seoul) + tm_borders(lwd = 2, col = \"gray20\") +\n  tm_layout(frame = TRUE, title = \"Color Infrared\", \n            title.size = 2, title.position = c(\"left\", \"top\"), \n            bg.color = \"white\", \n            inner.margins = c(0.05, 0.05, 0.05, 0.05)) +\n  tm_scale_bar(color.dark = \"gray60\", position = c(0.01, 0.01), size = 0.6, breaks = seq(0, 20, 5)) + \n  tm_credits(\"SANG-IL LEE, Geography Education at SNU, 2025\", \n             size = 0.7)\nmy_map\n```\n\n::: {.cell-output-display}\n![](4_1_image_transformation_files/figure-html/unnamed-chunk-5-1.png){width=4500}\n:::\n:::\n\n::: {.cell}\n\n:::\n\n\n밴드비를 계산한다.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nnew_R <- level2_landsat_seoul_st_mask[\"B5\"]/level2_landsat_seoul_st_mask[\"B4\"]\nnew_G <- level2_landsat_seoul_st_mask[\"B2\"]/level2_landsat_seoul_st_mask[\"B4\"]\nnew_B <- level2_landsat_seoul_st_mask[\"B10\"]/level2_landsat_seoul_st_mask[\"B5\"]\nnew_RGB <- c(new_R, new_G, new_B)\nnew_RGB_str <- new_RGB |> \n  stretch(minv = 0, maxv = 255, minq = 0.05, maxq = 0.95)\n```\n:::\n\n\n지도를 그린다.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmy_map <- tm_shape(new_RGB_str, raster.downsample = FALSE) + \n  tm_rgb(r = 1, g = 2, b = 3, legend.show = FALSE) +\n  tm_shape(seoul) + tm_borders(lwd = 2, col = \"gray20\") +\n  tm_layout(frame = TRUE, title = \"R = 5/4, G = 2/4, B = 10/5\", title.size = 2, \n            title.position = c(\"left\", \"top\"), bg.color = \"white\", \n            inner.margins = c(0.05, 0.05, 0.05, 0.05)) +\n  tm_scale_bar(color.dark = \"gray60\", position = c(0.01, 0.01), size = 0.6, breaks = seq(0, 20, 5)) + \n  tm_credits(\"SANG-IL LEE, Geography Education at SNU, 2025\", size = 0.7)\nmy_map\n```\n\n::: {.cell-output-display}\n![](4_1_image_transformation_files/figure-html/unnamed-chunk-8-1.png){width=4500}\n:::\n:::\n\n::: {.cell}\n\n:::\n\n\n## 분광 지수: 식생 지수\n\nNDVI(normaized difference vegetation index)를 계산한다.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nNDVI <- (level2_landsat_seoul_st_mask[[5]]-level2_landsat_seoul_st_mask[[4]])/(level2_landsat_seoul_st_mask[[5]]+level2_landsat_seoul_st_mask[[4]])\n```\n:::\n\n\n지도를 제작한다.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmy_palette <- colorRampPalette(brewer.pal(11, \"RdYlGn\"))(100)\nmy_map <- tm_shape(NDVI, raster.downsample = FALSE) + \n  tm_raster(style = \"cont\", palette = my_palette, title = \"NDVI\") +\n  tm_shape(seoul) + tm_borders(lwd = 2, col = \"gray20\") +\n  tm_legend(legend.position = c(0.85, 0.06)) +\n  tm_layout(frame = TRUE, title = \"NDVI\", title.size = 2, \n            title.position = c(\"left\", \"top\"), bg.color = \"white\", \n            inner.margins = c(0.05, 0.05, 0.05, 0.05)) +\n  tm_scale_bar(color.dark = \"gray60\", position = c(0.01, 0.01), size = 0.6, breaks = seq(0, 20, 5)) + \n  tm_credits(\"SANG-IL LEE, Geography Education at SNU, 2025\", size = 0.7)\nmy_map\n```\n\n::: {.cell-output-display}\n![](4_1_image_transformation_files/figure-html/unnamed-chunk-11-1.png){width=4500}\n:::\n:::\n\n::: {.cell}\n\n:::\n\n\n## 질감 변환\n\nNIR에 대한 분산을 계산한다.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlevel2_landsat_seoul_st_mask[\"B5\"] |> \n  focal(w = 3, fun = var) -> NIR_var\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nmy_map <- tm_shape(NIR_var, raster.downsample = FALSE) + \n  tm_raster(style = \"quantile\", palette = \"Greys\", n = 100, title = \"Std. Dev.\", legend.show = FALSE) +\n  tm_shape(seoul) + tm_borders(lwd = 2, col = \"gray20\") +\n  tm_legend(legend.position = c(0.85, 0.06)) +\n  tm_layout(frame = TRUE, title = \"Variance of NIR\", title.size = 2, \n            title.position = c(\"left\", \"top\"), bg.color = \"white\", \n            inner.margins = c(0.05, 0.05, 0.05, 0.05)) +\n  tm_scale_bar(color.dark = \"gray60\", position = c(0.01, 0.01), size = 0.6, breaks = seq(0, 20, 5)) + \n  tm_credits(\"SANG-IL LEE, Geography Education at SNU, 2025\", size = 0.7)\nmy_map\n```\n\n::: {.cell-output-display}\n![](4_1_image_transformation_files/figure-html/unnamed-chunk-14-1.png){width=4500}\n:::\n:::\n\n::: {.cell}\n\n:::\n\n\nNIR 분산, Red 분산, Green 분산을 구하여 RGB 지도를 만든다.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlevel2_landsat_seoul_st_mask[\"B5\"] |> \n  focal(w = 3, fun = var) -> NIR_var\nlevel2_landsat_seoul_st_mask[\"B4\"] |> \n  focal(w = 3, fun = var) -> Red_var\nlevel2_landsat_seoul_st_mask[\"B3\"] |> \n  focal(w = 3, fun = var) -> Green_var\nvar_stack <- c(NIR_var, Red_var, Green_var) |> stretch(minv = 0, maxv = 255, minq = 0.05, maxq = 0.95)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nmy_map <- tm_shape(var_stack, raster.downsample = FALSE) + \n  tm_rgb(r = 1, g = 2, b = 3, legend.show = FALSE) +\n  tm_shape(seoul) + tm_borders(lwd = 2, col = \"gray20\") +\n  tm_layout(frame = TRUE, title = \"RGB = NIR var, Red var, Green var\", \n            title.size = 2, title.position = c(\"left\", \"top\"), \n            bg.color = \"white\", inner.margins = c(0.05, 0.05, 0.05, 0.05)) +\n  tm_scale_bar(color.dark = \"gray60\", position = c(0.01, 0.01), size = 0.6, breaks = seq(0, 20, 5)) + \n  tm_credits(\"SANG-IL LEE, Geography Education at SNU, 2025\", size = 0.7)\nmy_map\n```\n\n::: {.cell-output-display}\n![](4_1_image_transformation_files/figure-html/unnamed-chunk-17-1.png){width=4500}\n:::\n:::\n\n::: {.cell}\n\n:::\n\n\n## 경관생태지수\n\n## PCA 변환\n\nPCA를 실행한다.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nPCA_res <- rasterPCA(\n  level2_landsat_seoul_st_mask,\n  spca = TRUE\n)\nPCA_map <- PCA_res$map |> stretch(minv = 0, maxv = 255, minq = 0.05, maxq = 0.95)\n```\n:::\n\n\nPCA의 결과를 일반적인 형식으로 변경한다.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsnu_PCA_res_recal <- function(PCA_RES){\n  res <- PCA_RES\n  n <- length(res$model$center)\n  recal <- bind_rows(as_tibble(res$model$loadings[1:n,]), as_tibble(t(res$model$sdev)))\n  recal <- recal |> mutate(\n    band_id = c(str_c(\"B\", 1:(n() - 1)), \"Eigen\"), .before = 1\n    ) \n  recal[1:n, 2:(n+1)] <- recal[1:n, 2:(n+1)] * recal[(n+1), 2:(n+1)][rep(1, n), ]\n  recal[(n + 1), 2:(n+1)] <- recal[(n + 1), 2:(n+1)]^2\n  recal[(n + 2), 2:(n+1)] <- recal[(n + 1), 2:(n+1)]*100/n\n  recal[(n + 2), 1] <- \"Pct\"\n  recal[(n + 3), 2:(n+1)] <- t(cumsum(as.numeric(recal[(n + 2), 2:(n+1)])))\n  recal[(n + 3), 1] <- \"Cum_Pct\"\n  recal\n  }\n\nsnu_PCA_res_recal(PCA_res)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 11 × 9\n   band_id  Comp.1  Comp.2   Comp.3  Comp.4   Comp.5   Comp.6    Comp.7   Comp.8\n   <chr>     <dbl>   <dbl>    <dbl>   <dbl>    <dbl>    <dbl>     <dbl>    <dbl>\n 1 B1       0.952   0.0923  0.208    0.151   0.132    0.0145   0.0243    3.34e-2\n 2 B2       0.968   0.142   0.162    0.0978  0.0628  -0.0161  -0.0194   -4.93e-2\n 3 B3       0.978   0.0744  0.126    0.0145 -0.122   -0.0500  -0.0608    2.12e-2\n 4 B4       0.973   0.114   0.104   -0.0240 -0.153    0.0363   0.0633   -7.24e-3\n 5 B5      -0.0417 -0.977   0.00117  0.201  -0.0449   0.0384  -0.0101   -3.00e-3\n 6 B6       0.771  -0.600  -0.107   -0.148   0.0461  -0.0916   0.0302   -3.18e-4\n 7 B7       0.945  -0.196  -0.0686  -0.229   0.0500   0.0904  -0.0315    1.40e-3\n 8 B8       0.781   0.253  -0.553    0.142  -0.00371  0.00278 -0.000423  1.40e-3\n 9 Eigen    5.85    1.46    0.418    0.168   0.0661   0.0223   0.0107    4.06e-3\n10 Pct     73.1    18.3     5.23     2.10    0.826    0.279    0.134     5.08e-2\n11 Cum_Pct 73.1    91.4    96.6     98.7    99.5     99.8     99.9       1.00e+2\n```\n\n\n:::\n:::\n\n\nPCA 지도를 제작한다.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmy_map <- tm_shape(PCA_map, raster.downsample = FALSE) +\n  tm_raster(style = \"cont\", palette = \"-Greys\", title = \"DN\") +\n  tm_facets(ncol = 4, free.scales = FALSE) +\n  tm_layout(legend.show = FALSE, panel.label.size = 2, \n            attr.outside = T, attr.outside.position = \"bottom\") +\n  tm_credits(text = \"SANG-IL LEE, Geography Education at SNU, 2025\", size = 1.5, position = c(0.75, \"top\"))\nmy_map\n```\n\n::: {.cell-output-display}\n![](4_1_image_transformation_files/figure-html/unnamed-chunk-21-1.png){width=4500}\n:::\n:::\n\n::: {.cell}\n\n:::\n\n\nPCA 1\\~3을 결합한 지도를 제작한다.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nPCA_R <- PCA_map$PC1\nPCA_G <- PCA_map$PC2\nPCA_B <- PCA_map$PC3\nPCA_stack <- c(PCA_R, PCA_G, PCA_B)\n```\n:::\n\n\n지도를 그린다.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmy_map <- tm_shape(PCA_stack, raster.downsample = FALSE) + \n  tm_rgb(r = 1, g = 2, b = 3, legend.show = FALSE) +\n  tm_shape(seoul) + tm_borders(lwd = 2, col = \"gray20\") +\n  tm_layout(frame = TRUE, title = \"RGB = PC1, PC2, PC3\", title.size = 2, \n            title.position = c(\"left\", \"top\"), \n            bg.color = \"white\", inner.margins = c(0.05, 0.05, 0.05, 0.05)) +\n  tm_scale_bar(color.dark = \"gray60\", position = c(0.01, 0.01), size = 0.6, breaks = seq(0, 20, 5)) + \n  tm_credits(\"SANG-IL LEE, Geography Education at SNU, 2025\", size = 0.7)\nmy_map\n```\n\n::: {.cell-output-display}\n![](4_1_image_transformation_files/figure-html/unnamed-chunk-24-1.png){width=4500}\n:::\n:::\n\n::: {.cell}\n\n:::\n",
    "supporting": [
      "4_1_image_transformation_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}